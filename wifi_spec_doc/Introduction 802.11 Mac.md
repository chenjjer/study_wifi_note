# Introduction 802.11 Mac

​		无线网络802.11 协议规范的关键在于MAC层（媒介访问控制层），MAC位于各式物理层至上，控制数据的传输。它负责核心帧操作以及与有限网络之间的交互。不同的物理层可能提供不同的传输速率，详见不同协议的data rate提升。

​		802.11协议相较于IEEE 802标准协议未进行较大的改动，802.11成功将Ethernet类型的网络应用到无线链路上，和Ethernet一样，802.11采用载波监听多路访问（carrier sense multiple access， CSMA)机制来控制堆传输媒介的访问。不过，冲突会浪费宝贵的传输资源，因此802.11转而使用冲突避免 **(CSMA/CA) ** 机制，而非使用Ethernet所实行的冲突检测机制。和Ethernet一样，802.11采用的是不具中枢控制功能的分布式访问机制，因此每个802.11工作站访问媒介的方式都一样。802.11与Ethernet之间的主要差异在与使用的底层媒介不同。

## 1. introduction 802.11 MAC

​		在802.11 Spec中，针对Non-DMG STA以及DMG STA有两种MAC架构，定义如下图。

<img src="C:/Users/chenjjsq/Desktop/wifi_spec_doc/image-20221121142900189.png" alt="image-20221121142900189" style="zoom:67%;" />

在此Mac系统架构中

- Mac层通过DCF架构向上提供PCF，HCF和MCF服务
- PCF是作为一个可选项在非mesh网络
- HCF是针对QOS服务的
- MCF是用在mesh网络中STA服务的

<img src="C:/Users/chenjjsq/Desktop/wifi_spec_doc/image-20221121143316456.png" alt="image-20221121143316456" style="zoom:67%;" />

此Mac架构中，MAC 层提供的服务都是基于使用DMG 信道竞争的机制，向上提供beamforming，ATI, CBAP以及SP等相关服务。

dmg是毫米波802.11ad，在实际的过程中，预计接触到的来看，更多的是基于non-DMG STA架构。因此后面重点将讲述Non-DMG相关的知识。

### 1.1 802.11 MAC所面临的挑战

在802.11 Mac层的设计中，由于无线网络环境与有线网络的差异性，因此802.11无线网络面临以下三大挑战：

1. 射频链路质量
2. 隐藏节点问题
3. 封包碰撞

### 1.1.1 射频链路质量

​		在有线的以太网中，假定对方必然会收到所传送的帧是合理的。无线链路则不然，特别是使用无须授权的 ISM 频段时。窄频（narrowband）传输将会受到噪声与干扰的影响，而不必使用执照的装置（unlicensed device）也必须假定干扰的存在，并且提供克服干扰的办法。为了克服微波炉及其他射频干扰源所导致的辐射问题， 802.11 设计人员曾经考虑过几种解决方案。除了噪声问题，多径衰落（multipath fading）所造成的传输死角（dead spot），也可能导致帧的无法传递。

​		和其他链路层协议不同，802.11 采用正面回应机制。所有传送出去的帧都必须得到回应，如下图所示，**只要任何一个环节失败，该帧即视为已经丢掉。**  

<img src="C:/Users/chenjjsq/Desktop/wifi_spec_doc/image-20221121162526230.png" alt="image-20221121162526230" style="zoom:80%;" />

​		如上图所示，上述为帧发送的基本操作(帧发送，此时左边设备定时器启动，右边设备收到此frame后，在timer设定的时间内回复ack）整个过程每个步骤的必要的，如果缺少某一部分，则会导致帧发送失败。基本处理单元可说是“非成即败“。数据帧的传送者必须收到应答ack，否则该帧被视为已经丢失。

​		无线电波的链路品质也会影响网络连接的速度。信号质量较好就可以用较高的速度来传送数据。信号质量通常随着距离的拉长而有所衰减，亦即802.11工作站的数据传输速度，取决于它和接入点之间的相对位置。但在实际的使用过程中，如果两台设备相隔太近会导致信号太强也会影响射频链路质量。

针对上述每个厂商会**设计自己的RA算法**，这样可以判定何时因环境的不变化来调节速率的变换，从而提高设备的连接效率和性能。	

### 1.1.2 隐藏节点问题

​		在以太网络中，工作站是通过CSMA/CD载波侦听功能，会详细记录各个网络节点的信息。但是在无线网络中的界限比较模糊，有时候并不是每个节点都可以跟其他节点直接通信，如图所示：

<img src="C:/Users/chenjjsq/Desktop/wifi_spec_doc/image-20221121174231307.png" alt="image-20221121174231307" style="zoom:80%;" />

正常情况下，Node1的范围表示为红色部分，node2表示为绿色部分，Node1与Node2可以正常通信。

但如果存在多个网络节点的情况下，如下图所示：

<img src="C:/Users/chenjjsq/Desktop/wifi_spec_doc/image-20221121174736028.png" alt="image-20221121174736028" style="zoom:80%;" />

Node2可以与Node3通信，node3与node4通信，对于节点1来说，节点3和节点4是隐藏节点，同样对于节点3和节点4来说，节点1是隐藏节点，由于没有双方都感知不到对方，容易造成节点1和节点3（或节点4）同时传输数据，从而无法解决导致数据正确的传输。

### 1.1.3 封包碰撞

​		该场景即适用与普通场景，对隐藏节点同样适用，如之前所述在802.3以太网络协议中，传输和检测可以同时进行，而无线网络则是半双工性质无法做到此功能，因此在实际的传输过程中会经常出现封包碰撞的情况，如下图所示：

<img src="C:/Users/chenjjsq/Desktop/wifi_spec_doc/image-20221121225223960.png" alt="image-20221121225223960" style="zoom:80%;" />

​		在传输过程中A和B同时传输，在C的位置发生碰撞，导致C不能够解析其波形，继续碰撞A也不会解析其波形，通过图形左边所示，往往在传输的过程中A传输的数据与A感知的数据是不一样的。



如之前所述，在无线网络中是采用半双工性质的，意味着不能够同时收发，即在传输和检测过程中不能够同时进行，为此802.11无线网络协议采用DCF在进行管控。

## 1.2 Mac访问控制与时钟

​		无线介质的访问，是有协调功能所管控，无线网的CSMA/CA访问，是有分布式协调功能（distributed coordination function，简称DCF）所管控。如果需要用到免竞争服务，则可通过架构与DCF之上的点协调功能（point coordination function，简称PCF)来管控。在各去所需的DCF与精确控制的PCF之间，也可以选择使用介于两种极端之间，采用中庸之道的混合式协调功能（HCF)。之前架构图所示。

<img src="C:/Users/chenjjsq/Desktop/wifi_spec_doc/image-20221121231540415.png" alt="image-20221121231540415" style="zoom:50%;" />

列表如下：

- DCF (distributed coordination function)
  - Contention-based
- PCF(point coordination function)
  - Contention free
- HCF(Hybrid coordination function)

之前提到的竞争，那什么是竞争呢？竞争是一种媒介访问方法，用于共享广播媒体。对于无线网络工作平台，在任何时刻都可以传输数据，由于都是使用的同一媒介或信道，这就会造成资源拥塞，进而可能导致

## reference

https://zhuanlan.zhihu.com/p/51412066



